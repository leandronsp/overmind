#!/bin/sh
set -e

SOCK="$HOME/.overmind/overmind.sock"
DAEMON="$(cd "$(dirname "$0")/.." && pwd)/overmind_daemon"
PIDFILE="$HOME/.overmind/daemon.pid"
LOGFILE="$HOME/.overmind/daemon.log"

# --- helpers ---

escape_json() {
  printf '%s' "$1" | sed 's/\\/\\\\/g; s/"/\\"/g'
}

send_cmd() {
  if [ ! -S "$SOCK" ]; then
    echo "Daemon not running. Start with: overmind start" >&2
    return 1
  fi
  response=$(printf '%s\n' "$1" | nc -U "$SOCK" 2>/dev/null) || {
    echo "Daemon not running. Start with: overmind start" >&2
    return 1
  }
  printf '%s' "$response"
}

extract_ok() {
  response="$1"
  if printf '%s' "$response" | grep -q '"error"'; then
    err=$(printf '%s' "$response" | sed 's/.*"error":"\([^"]*\)".*/\1/')
    echo "Error: $err" >&2
    return 1
  fi
  printf '%s' "$response" | sed 's/.*"ok":\(.*\)}/\1/' | sed 's/^"//; s/"$//'
}

unescape_json() {
  printf '%b' "$1"
}

# --- commands ---

cmd_start() {
  if [ -S "$SOCK" ]; then
    echo "Daemon is already running"
    return 0
  fi

  mkdir -p "$(dirname "$SOCK")"
  nohup "$DAEMON" __daemon__ > "$LOGFILE" 2>&1 &
  daemon_pid=$!
  echo "$daemon_pid" > "$PIDFILE"

  # wait for socket
  i=0
  while [ $i -lt 20 ]; do
    if [ -S "$SOCK" ]; then
      echo "Daemon started (PID $daemon_pid)"
      return 0
    fi
    sleep 0.25
    i=$((i + 1))
  done
  echo "Daemon process started but not yet reachable"
}

cmd_shutdown() {
  response=$(send_cmd '{"cmd":"shutdown"}') || return 0
  # wait for socket removal
  i=0
  while [ $i -lt 20 ]; do
    [ ! -S "$SOCK" ] && break
    sleep 0.1
    i=$((i + 1))
  done
  rm -f "$PIDFILE"
  echo "Daemon stopped"
}

cmd_run() {
  command=""
  type="task"
  provider="raw"
  cwd=""
  name=""

  while [ $# -gt 0 ]; do
    case "$1" in
      --type)     type="$2"; shift 2 ;;
      --provider) provider="$2"; shift 2 ;;
      --cwd)      cwd="$2"; shift 2 ;;
      --name)     name="$2"; shift 2 ;;
      *)          command="$command $1"; shift ;;
    esac
  done
  command=$(echo "$command" | sed 's/^ //')

  if [ -z "$command" ] && [ "$type" = "task" ]; then
    echo "Missing command. Usage: overmind run <command>"
    return 1
  fi

  escaped=$(escape_json "$command")
  extra=""
  if [ -n "$cwd" ]; then
    ecwd=$(escape_json "$cwd")
    extra="$extra,\"cwd\":\"$ecwd\""
  fi
  if [ -n "$name" ]; then
    ename=$(escape_json "$name")
    extra="$extra,\"name\":\"$ename\""
  fi
  json="{\"cmd\":\"run\",\"args\":{\"command\":\"$escaped\",\"type\":\"$type\",\"provider\":\"$provider\"$extra}}"
  response=$(send_cmd "$json") || return 1
  id=$(extract_ok "$response") || return 1
  echo "Started mission $id"
}

cmd_claude_run() {
  if [ $# -eq 0 ]; then
    echo "Missing prompt. Usage: overmind claude run <prompt>"
    return 1
  fi

  prompt="$*"
  escaped=$(escape_json "$prompt")
  json="{\"cmd\":\"run\",\"args\":{\"command\":\"$escaped\",\"type\":\"task\",\"provider\":\"claude\"}}"
  response=$(send_cmd "$json") || return 1
  id=$(extract_ok "$response") || return 1
  echo "Started mission $id"
}

cmd_ps() {
  response=$(send_cmd '{"cmd":"ps"}') || return 1
  text=$(extract_ok "$response") || return 1
  unescape_json "$text"
}

cmd_logs() {
  id="$1"
  escaped=$(escape_json "$id")
  response=$(send_cmd "{\"cmd\":\"logs\",\"args\":{\"id\":\"$escaped\"}}") || return 1
  text=$(extract_ok "$response") || return 1
  unescape_json "$text"
}

cmd_stop() {
  id="$1"
  escaped=$(escape_json "$id")
  response=$(send_cmd "{\"cmd\":\"stop\",\"args\":{\"id\":\"$escaped\"}}") || return 1
  extract_ok "$response" > /dev/null || return 1
  echo "Stopped mission $id"
}

cmd_kill() {
  id="$1"
  escaped=$(escape_json "$id")
  response=$(send_cmd "{\"cmd\":\"kill\",\"args\":{\"id\":\"$escaped\"}}") || return 1
  extract_ok "$response" > /dev/null || return 1
  echo "Killed mission $id"
}

cmd_send() {
  id="$1"
  shift
  message="$*"
  eid=$(escape_json "$id")
  emsg=$(escape_json "$message")
  response=$(send_cmd "{\"cmd\":\"send\",\"args\":{\"id\":\"$eid\",\"message\":\"$emsg\"}}") || return 1
  extract_ok "$response" > /dev/null || return 1
  echo "Sent to mission $id"
}

cmd_detach() {
  id="$1"
  escaped=$(escape_json "$id")
  response=$(send_cmd "{\"cmd\":\"unpause\",\"args\":{\"id\":\"$escaped\"}}") || return 1
  extract_ok "$response" > /dev/null || return 1
  echo "Detached from mission $id"
}

cmd_attach() {
  id="$1"
  escaped=$(escape_json "$id")
  response=$(send_cmd "{\"cmd\":\"pause\",\"args\":{\"id\":\"$escaped\"}}") || return 1
  session_id=$(extract_ok "$response") || return 1

  if [ "$session_id" = "null" ] || [ -z "$session_id" ]; then
    echo "Mission $id has no session ID yet"
    return 1
  fi

  # trap to unpause on exit
  trap "printf '{\"cmd\":\"unpause\",\"args\":{\"id\":\"$escaped\"}}' | nc -U \"$SOCK\" > /dev/null 2>&1" EXIT

  exec claude --resume "$session_id"
}

usage() {
  cat <<'EOF'
Overmind v0.1.0 â€” Kubernetes for AI Agents

Usage: overmind <command> [options]

Commands:
  start                    Start the daemon
  shutdown                 Stop the daemon
  run <command>            Spawn a raw command (task mode)
  run --type session       Spawn a session agent
  run --provider claude    Spawn with Claude provider
  run --cwd <path>         Set working directory
  run --name <name>        Set agent name (auto-generated if omitted)
  claude run <prompt>      Spawn a Claude agent (task mode)
  send <id> <message>      Send a message to a session
  attach <id>              Attach to a session (TUI)
  detach <id>              Unpause after manual attach
  ps                       List all missions
  logs <id>                Show mission logs
  stop <id>                Stop a mission (SIGTERM)
  kill <id>                Kill a mission (SIGKILL)
EOF
}

# --- main ---

case "${1:-}" in
  start)       cmd_start ;;
  shutdown)    cmd_shutdown ;;
  run)         shift; cmd_run "$@" ;;
  claude)
    if [ "${2:-}" = "run" ]; then
      shift 2; cmd_claude_run "$@"
    else
      echo "Unknown command: claude $2"
      usage
    fi
    ;;
  ps)          cmd_ps ;;
  logs)        cmd_logs "$2" ;;
  stop)        cmd_stop "$2" ;;
  kill)        cmd_kill "$2" ;;
  send)        shift; cmd_send "$@" ;;
  attach)      cmd_attach "$2" ;;
  detach)      cmd_detach "$2" ;;
  "")          usage ;;
  *)           echo "Unknown command: $1"; usage ;;
esac
